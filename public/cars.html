<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Veh칤culo - Frenos Hugo</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Registrar Veh칤culo</h1>
      <nav>
        <ul>
          <li><a href="index.html">Registrar Servicio</a></li>
          <li><a href="consultation.html">Consulta</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <!-- Changed action/method, will be handled by JS -->
      <form class="card" id="car-registration-form">
        <h3>Informaci칩n del Veh칤culo</h3>

        <!-- Mensaje informativo si viene desde el formulario de servicios -->
        <div
          id="info-message"
          style="
            display: none;
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
          "
        >
          <strong>游늶 Registro requerido:</strong><br />
          Debe completar el registro del veh칤culo para continuar con el
          servicio.
        </div>

        <label for="plate">Placa:</label>
        <input
          type="text"
          id="plate"
          name="plate"
          style="text-transform: uppercase"
          required
        />

        <label for="brand">Marca:</label>
        <input
          type="text"
          id="brand"
          name="brand"
          style="text-transform: uppercase"
          required
        />

        <label for="model">Modelo:</label>
        <input
          type="text"
          id="model"
          name="model"
          style="text-transform: uppercase"
          required
        />

        <label for="owner">Propietario:</label>
        <input
          type="text"
          id="owner"
          name="owner"
          style="text-transform: uppercase"
          required
        />

        <label for="phone">Tel칠fono:</label>
        <input type="tel" id="phone" name="phone" required />

        <button type="submit">Registrar Veh칤culo</button>
      </form>
      <div id="message-area" style="margin-top: 15px; text-align: center"></div>
    </main>
    <footer>
      <p>&copy; 2025 Frenos Hugo. Todos los derechos reservados.</p>
    </footer>

    <script>
      const form = document.getElementById("car-registration-form");
      const messageArea = document.getElementById("message-area");

      // Pre-fill plate and get workOrder from URL
      const urlParams = new URLSearchParams(window.location.search);
      const plateFromUrl = urlParams.get("plate");
      const workOrderFromUrl = urlParams.get("workOrder"); // Get workOrder
      const infoMessage = document.getElementById("info-message");

      if (plateFromUrl) {
        document.getElementById("plate").value = plateFromUrl;

        // Mostrar mensaje informativo si viene desde el formulario de servicios
        if (workOrderFromUrl) {
          infoMessage.style.display = "block";
          infoMessage.innerHTML = `
            <strong>游늶 Registro requerido:</strong><br>
            La placa <strong>${plateFromUrl}</strong> no est치 registrada. Complete este formulario para continuar con el servicio de la orden de trabajo <strong>#${workOrderFromUrl}</strong>.
          `;
        }
      }

      form.addEventListener("submit", async function (event) {
        event.preventDefault();
        messageArea.textContent = "";
        messageArea.style.color = "black";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          // Usar la API correcta de PostgreSQL
          const response = await fetch("/api/cars", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              placa: data.plate,
              marca: data.brand,
              modelo: data.model,
              a침o: data.year ? parseInt(data.year) : null,
              color: data.color,
              propietario: data.owner,
              telefono: data.phone,
              email: data.email,
            }),
          });

          const responseData = await response.json();

          if (response.ok) {
            // Status 200 Success - Redirecci칩n directa sin modal
            const vehicleData = responseData.data;

            if (workOrderFromUrl) {
              // Si hay n칰mero de orden, redirigir directamente al registro de servicio
              const redirectUrl = `index.html?plate=${encodeURIComponent(
                vehicleData.placa
              )}&workOrder=${encodeURIComponent(workOrderFromUrl)}`;
              window.location.href = redirectUrl;
            } else {
              // Si no hay n칰mero de orden, redirigir al registro de servicio con solo la placa
              const redirectUrl = `index.html?plate=${encodeURIComponent(
                vehicleData.placa
              )}`;
              window.location.href = redirectUrl;
            }
          } else {
            // Handle errors (like 409 Conflict for duplicate plate)
            messageArea.textContent = `Error: ${
              responseData.message || "Ocurri칩 un error desconocido."
            }`;
            messageArea.style.color = "red";
          }
        } catch (error) {
          console.error("Error al registrar veh칤culo:", error);
          messageArea.textContent =
            "Error de conexi칩n o al procesar la solicitud. Intente nuevamente.";
          messageArea.style.color = "red";
        }
      });
    </script>
  </body>
</html>
