<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Servicios - Frenos Hugo</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Registrar Servicio</h1>
      <nav>
        <ul>
          <li><a href="cars.html">Vehículos</a></li>
          <li><a href="consultation.html">Consulta</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <form class="card" id="serviceForm">
        <h3>Información del Servicio</h3>

        <label for="workOrder">Orden de Trabajo:</label>
        <input type="number" id="workOrder" name="workOrder" required />

        <label for="plate">Placa:</label>
        <input
          type="text"
          id="plate"
          name="plate"
          style="text-transform: uppercase"
          required
        />

        <!-- Invoice Section -->
        <div id="invoice-items-container">
          <label>Detalles del Servicio:</label>
          <!-- Invoice rows will be added here -->
        </div>
        <button type="button" id="add-invoice-item-btn">
          + Añadir Detalle
        </button>

        <div id="invoice-total-container">
          <strong>Total Calculado:</strong>
          <span id="invoice-total">$0.00</span>
        </div>

        <button type="submit">Registrar Servicio</button>
      </form>
      <div id="message-area" style="margin-top: 15px; text-align: center"></div>
    </main>
    <footer>
      <p>&copy; 2025 Frenos Hugo. Todos los derechos reservados.</p>
    </footer>

    <script>
      // Pre-fill plate and workOrder from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const plateFromUrl = urlParams.get("plate");
      const workOrderFromUrl = urlParams.get("workOrder");

      const plateInput = document.getElementById("plate");
      const workOrderInput = document.getElementById("workOrder");
      const messageArea = document.getElementById("message-area");

      if (plateFromUrl) {
        plateInput.value = plateFromUrl;
      }
      if (workOrderFromUrl) {
        workOrderInput.value = workOrderFromUrl;
      }

      const invoiceItemsContainer = document.getElementById("invoice-items-container");
      const addInvoiceItemBtn = document.getElementById("add-invoice-item-btn");
      const invoiceTotalSpan = document.getElementById("invoice-total");

      // --- Invoice Functions ---
      function createInvoiceRow() {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("invoice-item-row");
        rowDiv.style.cssText = "display: flex; gap: 10px; margin-bottom: 10px; align-items: center;";

        const detailInput = document.createElement("input");
        detailInput.type = "text";
        detailInput.placeholder = "Detalle del servicio";
        detailInput.classList.add("invoice-item-detail");
        detailInput.style.cssText = "flex: 2; text-transform: uppercase; padding: 8px; border: 1px solid #ddd; border-radius: 4px;";

        const valueInput = document.createElement("input");
        valueInput.type = "number";
        valueInput.placeholder = "Valor";
        valueInput.classList.add("invoice-item-value");
        valueInput.min = "0";
        valueInput.step = "0.01";
        valueInput.style.cssText = "flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "−";
        removeBtn.classList.add("remove-invoice-item-btn");
        removeBtn.style.cssText = "background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;";

        rowDiv.appendChild(detailInput);
        rowDiv.appendChild(valueInput);
        rowDiv.appendChild(removeBtn);
        invoiceItemsContainer.appendChild(rowDiv);

        // Add event listeners for the new row
        valueInput.addEventListener("input", calculateTotal);
        valueInput.addEventListener("keydown", handleValueEnter);
        removeBtn.addEventListener("click", () => {
          rowDiv.remove();
          calculateTotal();
        });

        detailInput.focus(); // Focus on the detail input of the new row
        return rowDiv;
      }

      function handleValueEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          createInvoiceRow(); // Add a new row when Enter is pressed in the value field
        }
      }

      function calculateTotal() {
        const valueInputs = invoiceItemsContainer.querySelectorAll(".invoice-item-value");
        let total = 0;
        valueInputs.forEach((input) => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        // Format as currency (e.g., COP)
        invoiceTotalSpan.textContent = new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
        }).format(total);
      }

      // --- Initial Setup ---
      addInvoiceItemBtn.addEventListener("click", (e) => {
        e.preventDefault();
        createInvoiceRow();
      });
      
      // Start with one empty row
      createInvoiceRow();

      // -- Form Submit Listener --
      document.getElementById("serviceForm").addEventListener("submit", async function (event) {
        event.preventDefault();
        
        messageArea.textContent = "";
        messageArea.style.color = "black";

        const plate = plateInput.value.toUpperCase().trim();
        const workOrderValue = workOrderInput.value.trim();

        if (!plate || !workOrderValue) {
          messageArea.textContent = "Por favor complete todos los campos requeridos.";
          messageArea.style.color = "red";
          return;
        }

        // --- Gather Invoice Data ---
        const invoiceRows = invoiceItemsContainer.querySelectorAll(".invoice-item-row");
        let workDescription = "";
        let calculatedCost = 0;
        let validItemsCount = 0;

        for (let i = 0; i < invoiceRows.length; i++) {
          const row = invoiceRows[i];
          const detailInput = row.querySelector(".invoice-item-detail");
          const valueInput = row.querySelector(".invoice-item-value");
          const detail = detailInput.value.trim().toUpperCase();
          const valueStr = valueInput.value.trim();
          const value = parseFloat(valueStr);

          // Skip empty rows
          if (!detail && (!valueStr || value === 0)) {
            continue;
          }

          // Validate non-empty rows
          if (!detail) {
            messageArea.textContent = `Por favor, ingrese un detalle para el ítem ${i + 1}.`;
            messageArea.style.color = "red";
            detailInput.focus();
            return;
          }

          if (!valueStr || isNaN(value) || value < 0) {
            messageArea.textContent = `Por favor, ingrese un valor válido para el ítem ${i + 1}.`;
            messageArea.style.color = "red";
            valueInput.focus();
            return;
          }

          workDescription += `${detail}: ${new Intl.NumberFormat("es-CO", {
            style: "currency",
            currency: "COP",
          }).format(value)}\\n`;
          calculatedCost += value;
          validItemsCount++;
        }

        if (validItemsCount === 0) {
          messageArea.textContent = "Por favor, añada al menos un detalle de servicio válido.";
          messageArea.style.color = "red";
          return;
        }

        // Submit service
        try {
          messageArea.textContent = "Registrando servicio...";
          messageArea.style.color = "blue";

          const response = await fetch("/api/services", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orden_trabajo: parseInt(workOrderValue),
              placa: plate,
              tipo_servicio: "Servicio múltiple",
              descripcion: workDescription.trim(),
              costo: calculatedCost
            }),
          });

          const responseData = await response.json();

          if (response.ok) {
            messageArea.textContent = responseData.message || "Servicio registrado exitosamente";
            messageArea.style.color = "green";
            
            // Reset form
            this.reset();
            // Clear invoice items and add one empty row
            invoiceItemsContainer.innerHTML = '<label>Detalles del Servicio:</label>';
            createInvoiceRow();
            calculateTotal();
          } else {
            messageArea.textContent = `Error: ${responseData.message || "Ocurrió un error"}`;
            messageArea.style.color = "red";
          }
        } catch (error) {
          console.error("Error al registrar servicio:", error);
          messageArea.textContent = "Error de conexión. Intente nuevamente.";
          messageArea.style.color = "red";
        }
      });
    </script>
  </body>
</html>
