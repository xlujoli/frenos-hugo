<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Servicios - Frenos Hugo</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Estilos adicionales para mejorar el formulario */
      #invoice-items-container {
        margin: 15px 0;
      }

      #add-invoice-item-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 15px;
        transition: background-color 0.2s;
      }

      #add-invoice-item-btn:hover {
        background: #218838;
      }

      #invoice-total-container {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin: 15px 0;
        text-align: right;
        border: 1px solid #dee2e6;
      }

      #invoice-total {
        color: #007bff;
        font-size: 18px;
        font-weight: bold;
      }

      .card input[type="number"],
      .card input[type="text"] {
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        width: 100%;
        box-sizing: border-box;
      }

      .card label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
        color: #495057;
      }
      
      #plate-status {
        min-height: 24px;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        background: #f8f9fa;
        border: 1px solid transparent;
      }
      
      #plate-status:empty {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Registrar Servicio</h1>
      <nav>
        <ul>
          <li><a href="cars.html">Veh√≠culos</a></li>
          <li><a href="consultation.html">Consulta</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <form class="card" id="serviceForm">
        <h3>Informaci√≥n del Servicio</h3>

        <label for="workOrder">Orden de Trabajo:</label>
        <input type="number" id="workOrder" name="workOrder" required />

        <label for="plate">Placa:</label>
        <input
          type="text"
          id="plate"
          name="plate"
          style="text-transform: uppercase"
          required
        />
        
        <!-- Estado de verificaci√≥n de placa -->
        <div id="plate-status" style="margin-top: 8px; min-height: 24px; font-size: 14px; font-weight: 500;">
          <!-- Aqu√≠ se mostrar√° el estado de verificaci√≥n -->
        </div>

        <!-- Invoice Section -->
        <div id="invoice-items-container">
          <label>Detalles del Servicio:</label>
          <!-- Invoice rows will be added here -->
        </div>
        <button type="button" id="add-invoice-item-btn">
          + A√±adir Detalle
        </button>

        <div id="invoice-total-container">
          <strong>Total Calculado:</strong>
          <span id="invoice-total">$0.00</span>
        </div>

        <button type="submit">Registrar Servicio</button>
      </form>
      <div id="message-area" style="margin-top: 15px; text-align: center"></div>
    </main>
    <footer>
      <p>&copy; 2025 Frenos Hugo. Todos los derechos reservados.</p>
    </footer>

    <script>
      // Pre-fill plate and workOrder from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const plateFromUrl = urlParams.get("plate");
      const workOrderFromUrl = urlParams.get("workOrder");

      const plateInput = document.getElementById("plate");
      const workOrderInput = document.getElementById("workOrder");
      const messageArea = document.getElementById("message-area");
      const plateStatus = document.getElementById("plate-status");

      // Variable para almacenar el estado de verificaci√≥n de la placa
      let plateVerificationStatus = {
        verified: false,
        exists: false,
        vehicleData: null,
        lastCheckedPlate: ""
      };

      if (plateFromUrl) {
        plateInput.value = plateFromUrl;
        // Verificar autom√°ticamente si la placa viene de URL
        setTimeout(() => verifyPlateAutomatically(plateFromUrl), 500);
      }
      if (workOrderFromUrl) {
        workOrderInput.value = workOrderFromUrl;
      }

      // --- Funciones de verificaci√≥n de placa ---
      async function verifyPlateAutomatically(plate) {
        if (!plate || plate.length < 3) {
          plateStatus.innerHTML = "";
          plateVerificationStatus.verified = false;
          return;
        }

        const cleanPlate = plate.toUpperCase().trim();
        
        // No verificar si ya se verific√≥ la misma placa
        if (plateVerificationStatus.lastCheckedPlate === cleanPlate && plateVerificationStatus.verified) {
          return;
        }

        try {
          plateStatus.innerHTML = `<span style="color: #007bff;">üîç Verificando placa ${cleanPlate}...</span>`;
          
          const response = await fetch(`/api/cars/verify/${encodeURIComponent(cleanPlate)}`);
          const data = await response.json();

          if (response.ok && data.success) {
            plateVerificationStatus.verified = true;
            plateVerificationStatus.lastCheckedPlate = cleanPlate;
            
            if (data.exists) {
              plateVerificationStatus.exists = true;
              plateVerificationStatus.vehicleData = data.data;
              
              plateStatus.innerHTML = `
                <span style="color: #28a745;">
                  ‚úÖ ${data.data.marca} ${data.data.modelo} - ${data.data.propietario}
                </span>
              `;
            } else {
              plateVerificationStatus.exists = false;
              plateVerificationStatus.vehicleData = null;
              
              plateStatus.innerHTML = `
                <span style="color: #dc3545;">
                  ‚ùå Placa no registrada - 
                  <a href="#" onclick="redirectToCreateVehicle('${cleanPlate}')" style="color: #007bff; text-decoration: underline;">
                    Registrar veh√≠culo
                  </a>
                </span>
              `;
            }
          } else {
            plateStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Error al verificar placa</span>`;
            plateVerificationStatus.verified = false;
          }
        } catch (error) {
          console.error("Error verificando placa:", error);
          plateStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Error de conexi√≥n</span>`;
          plateVerificationStatus.verified = false;
        }
      }

      function redirectToCreateVehicle(plate) {
        const workOrder = workOrderInput.value.trim();
        let url = `cars.html?plate=${encodeURIComponent(plate)}`;
        if (workOrder) {
          url += `&workOrder=${encodeURIComponent(workOrder)}`;
        }
        window.location.href = url;
      }

      // Event listeners para verificaci√≥n autom√°tica de placa
      plateInput.addEventListener('blur', function() {
        const plate = this.value.trim();
        if (plate) {
          verifyPlateAutomatically(plate);
        }
      });

      plateInput.addEventListener('keydown', function(event) {
        if (event.key === 'Tab' || event.key === 'Enter') {
          const plate = this.value.trim();
          if (plate) {
            setTimeout(() => verifyPlateAutomatically(plate), 100);
          }
        }
      });

      // Limpiar estado cuando el usuario est√° escribiendo
      plateInput.addEventListener('input', function() {
        const currentPlate = this.value.trim().toUpperCase();
        if (currentPlate !== plateVerificationStatus.lastCheckedPlate) {
          plateStatus.innerHTML = "";
          plateVerificationStatus.verified = false;
          plateVerificationStatus.exists = false;
        }
      });

      const invoiceItemsContainer = document.getElementById(
        "invoice-items-container"
      );
      const addInvoiceItemBtn = document.getElementById("add-invoice-item-btn");
      const invoiceTotalSpan = document.getElementById("invoice-total");

      // --- Invoice Functions ---
      function createInvoiceRow() {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("invoice-item-row");
        rowDiv.style.cssText =
          "display: flex; gap: 8px; margin-bottom: 12px; align-items: center; width: 100%;";

        const detailInput = document.createElement("input");
        detailInput.type = "text";
        detailInput.placeholder = "Detalle del servicio";
        detailInput.classList.add("invoice-item-detail");
        detailInput.style.cssText =
          "flex: 3; text-transform: uppercase; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;";

        const valueInput = document.createElement("input");
        valueInput.type = "number";
        valueInput.placeholder = "Valor";
        valueInput.classList.add("invoice-item-value");
        valueInput.min = "0";
        valueInput.step = "0.01";
        valueInput.style.cssText =
          "flex: 1.5; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 120px;";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "√ó";
        removeBtn.classList.add("remove-invoice-item-btn");
        removeBtn.style.cssText =
          "background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;";

        rowDiv.appendChild(detailInput);
        rowDiv.appendChild(valueInput);
        rowDiv.appendChild(removeBtn);
        invoiceItemsContainer.appendChild(rowDiv);

        // Add event listeners for the new row
        valueInput.addEventListener("input", calculateTotal);
        valueInput.addEventListener("keydown", handleValueEnter);
        removeBtn.addEventListener("click", () => {
          rowDiv.remove();
          calculateTotal();
        });

        detailInput.focus(); // Focus on the detail input of the new row
        return rowDiv;
      }

      function handleValueEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          createInvoiceRow(); // Add a new row when Enter is pressed in the value field
        }
      }

      function calculateTotal() {
        const valueInputs = invoiceItemsContainer.querySelectorAll(
          ".invoice-item-value"
        );
        let total = 0;
        valueInputs.forEach((input) => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        // Format as currency (e.g., COP)
        invoiceTotalSpan.textContent = new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
        }).format(total);
      }

      // --- Initial Setup ---
      addInvoiceItemBtn.addEventListener("click", (e) => {
        e.preventDefault();
        createInvoiceRow();
      });

      // Start with one empty row
      createInvoiceRow();

      // -- Form Submit Listener --
      document
        .getElementById("serviceForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          messageArea.textContent = "";
          messageArea.style.color = "black";

          const plate = plateInput.value.toUpperCase().trim();
          const workOrderValue = workOrderInput.value.trim();

          if (!plate || !workOrderValue) {
            messageArea.textContent =
              "Por favor complete todos los campos requeridos.";
            messageArea.style.color = "red";
            return;
          }

          // --- Verificar placa usando la verificaci√≥n previa ---
          if (!plateVerificationStatus.verified || plateVerificationStatus.lastCheckedPlate !== plate) {
            // Si no se ha verificado o la placa cambi√≥, verificar ahora
            messageArea.textContent = "Verificando veh√≠culo...";
            messageArea.style.color = "blue";
            
            await verifyPlateAutomatically(plate);
            
            // Esperar un momento para que se complete la verificaci√≥n
            await new Promise(resolve => setTimeout(resolve, 500));
          }

          // Verificar el estado actual de la placa
          if (!plateVerificationStatus.verified) {
            messageArea.textContent = "Error al verificar el veh√≠culo. Intente nuevamente.";
            messageArea.style.color = "red";
            return;
          }

          if (!plateVerificationStatus.exists) {
            const confirmCreate = confirm(
              `‚ùå VEH√çCULO NO REGISTRADO\\n\\n` +
                `La placa "${plate}" no se encuentra en el sistema.\\n\\n` +
                `Para continuar con el registro del servicio, primero debe registrar el veh√≠culo.\\n\\n` +
                `¬øDesea registrar este veh√≠culo ahora?\\n\\n` +
                `‚Ä¢ Presione 'Aceptar' para ir al formulario de registro de veh√≠culos\\n` +
                `‚Ä¢ Presione 'Cancelar' para corregir la placa`
            );

            if (confirmCreate) {
              // Redirigir al formulario de crear veh√≠culo con la placa y orden de trabajo
              window.location.href = `cars.html?plate=${encodeURIComponent(plate)}&workOrder=${encodeURIComponent(workOrderValue)}`;
              return;
            } else {
              messageArea.textContent = "‚ùå Registro cancelado. Verifique la placa o registre el veh√≠culo primero.";
              messageArea.style.color = "orange";
              plateInput.focus();
              plateInput.select();
              return;
            }
          }

          // Si llegamos aqu√≠, la placa existe y est√° verificada
          const vehicleData = plateVerificationStatus.vehicleData;
          messageArea.textContent = `‚úÖ Veh√≠culo verificado: ${vehicleData.marca} ${vehicleData.modelo} - Propietario: ${vehicleData.propietario}`;
          messageArea.style.color = "green";

          // Peque√±a pausa para mostrar la verificaci√≥n exitosa
          setTimeout(() => {
            messageArea.textContent = "Procesando detalles del servicio...";
            messageArea.style.color = "blue";
          }, 800);

          // --- Gather Invoice Data ---
          const invoiceRows =
            invoiceItemsContainer.querySelectorAll(".invoice-item-row");
          let workDescription = "";
          let calculatedCost = 0;
          let validItemsCount = 0;

          for (let i = 0; i < invoiceRows.length; i++) {
            const row = invoiceRows[i];
            const detailInput = row.querySelector(".invoice-item-detail");
            const valueInput = row.querySelector(".invoice-item-value");
            const detail = detailInput.value.trim().toUpperCase();
            const valueStr = valueInput.value.trim();
            const value = parseFloat(valueStr);

            // Skip empty rows
            if (!detail && (!valueStr || value === 0)) {
              continue;
            }

            // Validate non-empty rows
            if (!detail) {
              messageArea.textContent = `Por favor, ingrese un detalle para el √≠tem ${
                i + 1
              }.`;
              messageArea.style.color = "red";
              detailInput.focus();
              return;
            }

            if (!valueStr || isNaN(value) || value < 0) {
              messageArea.textContent = `Por favor, ingrese un valor v√°lido para el √≠tem ${
                i + 1
              }.`;
              messageArea.style.color = "red";
              valueInput.focus();
              return;
            }

            workDescription += `${detail}: ${new Intl.NumberFormat("es-CO", {
              style: "currency",
              currency: "COP",
            }).format(value)}\\n`;
            calculatedCost += value;
            validItemsCount++;
          }

          if (validItemsCount === 0) {
            messageArea.textContent =
              "Por favor, a√±ada al menos un detalle de servicio v√°lido.";
            messageArea.style.color = "red";
            return;
          }

          // Submit service
          try {
            messageArea.textContent = "Registrando servicio...";
            messageArea.style.color = "blue";

            const response = await fetch("/api/services", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orden_trabajo: parseInt(workOrderValue),
                placa: plate,
                tipo_servicio: "Servicio m√∫ltiple",
                descripcion: workDescription.trim(),
                costo: calculatedCost,
              }),
            });

            const responseData = await response.json();

            if (response.ok) {
              messageArea.textContent =
                responseData.message || "Servicio registrado exitosamente";
              messageArea.style.color = "green";

              // Reset form
              this.reset();
              // Clear invoice items and add one empty row
              invoiceItemsContainer.innerHTML =
                "<label>Detalles del Servicio:</label>";
              createInvoiceRow();
              calculateTotal();
            } else {
              messageArea.textContent = `Error: ${
                responseData.message || "Ocurri√≥ un error"
              }`;
              messageArea.style.color = "red";
            }
          } catch (error) {
            console.error("Error al registrar servicio:", error);
            messageArea.textContent = "Error de conexi√≥n. Intente nuevamente.";
            messageArea.style.color = "red";
          }
        });
    </script>
  </body>
</html>
