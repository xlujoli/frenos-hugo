<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Servicios - Frenos Hugo</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="auth.js"></script>
    <style>
      /* Estilos adicionales para mejorar el formulario */
      #invoice-items-container {
        margin: 15px 0;
      }

      #invoice-total-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: center;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }

      #invoice-total-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.1) 25%,
            transparent 25%
          ),
          linear-gradient(-45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%),
          linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        opacity: 0.1;
      }

      #invoice-total-container strong {
        color: white;
        font-size: 16px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 1;
      }

      #invoice-total {
        color: #ffd700;
        font-size: 24px;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 1;
        margin-left: 10px;
        display: inline-block;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .card input[type="number"],
      .card input[type="text"] {
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        width: 100%;
        box-sizing: border-box;
      }

      .card label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
        color: #495057;
      }

      #plate-status {
        min-height: 24px;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        background: #f8f9fa;
        border: 1px solid transparent;
      }

      #plate-status:empty {
        display: none;
      }

      /* Estilos para el bot√≥n de cerrar sesi√≥n */
      .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
      }

      .logout-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      nav ul {
        display: flex;
        align-items: center;
      }

      /* Estilos para el bot√≥n de agregar detalle */
      .add-detail-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 15px 0;
        width: auto !important;
        max-width: 180px;
        display: block;
        text-align: center;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        position: relative;
        overflow: hidden;
        text-transform: capitalize;
        letter-spacing: 0.5px;
      }

      .add-detail-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .add-detail-btn:hover::before {
        left: 100%;
      }

      .add-detail-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
      }

      .add-detail-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Registrar Servicio</h1>
      <nav>
        <ul>
          <li><a href="cars.html">Veh√≠culos</a></li>
          <li><a href="consultation.html">Consulta</a></li>
          <li>
            <button id="logoutBtn" class="logout-btn">üö™ Cerrar Sesi√≥n</button>
          </li>
        </ul>
      </nav>
    </header>
    <main>
      <form class="card" id="serviceForm">
        <h3>Informaci√≥n del Servicio</h3>

        <label for="workOrder">Orden de Trabajo:</label>
        <input type="number" id="workOrder" name="workOrder" required />
        <div
          id="workOrderError"
          class="error-message"
          style="display: none; color: red; font-size: 12px; margin-top: 5px"
        ></div>

        <label for="plate">Placa:</label>
        <input
          type="text"
          id="plate"
          name="plate"
          style="text-transform: uppercase"
          required
        />

        <!-- Estado de verificaci√≥n de placa -->
        <div
          id="plate-status"
          style="
            margin-top: 8px;
            min-height: 24px;
            font-size: 14px;
            font-weight: 500;
          "
        >
          <!-- Aqu√≠ se mostrar√° el estado de verificaci√≥n -->
        </div>

        <!-- Invoice Section -->
        <div id="invoice-items-container">
          <label>Detalles del Servicio:</label>
          <!-- Invoice rows will be added here -->
        </div>

        <button type="button" id="add-detail-btn" class="add-detail-btn">
          ‚ûï Agregar detalle
        </button>

        <div id="invoice-total-container">
          <strong>Total Calculado:</strong>
          <span id="invoice-total">$0.00</span>
        </div>

        <button type="submit" id="submit-btn">Registrar Servicio</button>
      </form>
      <div id="message-area" style="margin-top: 15px; text-align: center"></div>
    </main>
    <footer>
      <p>&copy; 2025 Frenos Hugo. Todos los derechos reservados.</p>
    </footer>

    <script>
      // Pre-fill plate and workOrder from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const plateFromUrl = urlParams.get("plate");
      const workOrderFromUrl = urlParams.get("workOrder");

      const plateInput = document.getElementById("plate");
      const workOrderInput = document.getElementById("workOrder");
      const workOrderError = document.getElementById("workOrderError");
      const messageArea = document.getElementById("message-area");
      const plateStatus = document.getElementById("plate-status");

      // Variable para almacenar el estado de verificaci√≥n de la placa
      let plateVerificationStatus = {
        verified: false,
        exists: false,
        vehicleData: null,
        lastCheckedPlate: "",
      };

      // Variable para almacenar el estado de verificaci√≥n del n√∫mero de orden
      let workOrderVerificationStatus = {
        verified: false,
        isUnique: true,
        lastCheckedWorkOrder: "",
      };

      if (plateFromUrl) {
        plateInput.value = plateFromUrl;
        // Verificar autom√°ticamente si la placa viene de URL
        setTimeout(() => verifyPlateAutomatically(plateFromUrl), 500);
      }
      if (workOrderFromUrl) {
        workOrderInput.value = workOrderFromUrl;
        // Verificar autom√°ticamente si el n√∫mero de orden viene de URL
        setTimeout(() => verifyWorkOrderNumber(workOrderFromUrl), 500);
      }

      // --- Funciones del modal personalizado ---
      // --- Funciones de verificaci√≥n de placa ---
      function clearServiceForm() {
        // Limpiar formulario para nuevo servicio
        document.getElementById("serviceForm").reset();
        plateVerificationStatus = {
          verified: false,
          exists: false,
          vehicleData: null,
          lastCheckedPlate: "",
        };
        workOrderVerificationStatus = {
          verified: false,
          isUnique: true,
          lastCheckedWorkOrder: "",
        };
        plateStatus.innerHTML = "";
        workOrderError.style.display = "none";
        messageArea.textContent = "";
        messageArea.style.color = "black";

        // Restaurar apariencia normal de los campos
        workOrderInput.style.borderColor = "#ddd";
        workOrderInput.style.backgroundColor = "white";

        invoiceItemsContainer.innerHTML =
          "<label>Detalles del Servicio:</label>";
        createInvoiceRow();
        calculateTotal();
        // Focus en orden de trabajo
        workOrderInput.focus();
      }

      async function verifyWorkOrderNumber(workOrderNumber) {
        console.log("üîç Verificando n√∫mero de orden:", workOrderNumber);
        console.log("üìä Estado actual:", workOrderVerificationStatus);

        if (!workOrderNumber) {
          console.log("‚ùå Saliendo - n√∫mero vac√≠o");
          return false;
        }

        // Si ya verificamos este n√∫mero, usar el resultado previo
        if (
          workOrderNumber ===
            workOrderVerificationStatus.lastCheckedWorkOrder &&
          workOrderVerificationStatus.verified
        ) {
          console.log(
            "‚úÖ Usando resultado previo:",
            workOrderVerificationStatus.isUnique
          );
          return workOrderVerificationStatus.isUnique;
        }

        try {
          workOrderError.style.display = "none";
          workOrderVerificationStatus.lastCheckedWorkOrder = workOrderNumber;

          console.log("üîó Consultando API /api/services...");
          // Obtener todos los servicios para verificar duplicados
          const response = await fetch("/api/services");
          if (!response.ok) {
            throw new Error("Error al verificar n√∫mero de orden");
          }

          const responseData = await response.json();
          console.log("üìã Respuesta completa:", responseData);

          // Extraer el array de servicios de la respuesta
          const services = responseData.data || responseData;
          console.log("üìã Servicios extra√≠dos:", services.length);

          const existingService = services.find(
            (service) => service.orden_trabajo == workOrderNumber
          );

          console.log("üîç Servicio existente encontrado:", existingService);

          if (existingService) {
            console.log("‚ö†Ô∏è N√öMERO DUPLICADO DETECTADO");
            workOrderError.textContent = `‚ö†Ô∏è El n√∫mero de orden ${workOrderNumber} ya existe`;
            workOrderError.style.display = "block";
            workOrderVerificationStatus.verified = true;
            workOrderVerificationStatus.isUnique = false;

            // Hacer que el campo se vea como error
            workOrderInput.style.borderColor = "#dc3545";
            workOrderInput.style.backgroundColor = "#fff5f5";

            return false; // N√∫mero duplicado
          } else {
            console.log("‚úÖ N√∫mero de orden √∫nico");
            workOrderError.style.display = "none";
            workOrderVerificationStatus.verified = true;
            workOrderVerificationStatus.isUnique = true;

            // Restaurar apariencia normal del campo
            workOrderInput.style.borderColor = "#ddd";
            workOrderInput.style.backgroundColor = "white";

            return true; // N√∫mero √∫nico
          }
        } catch (error) {
          console.error("‚ùå Error verificando n√∫mero de orden:", error);
          workOrderError.textContent = "Error al verificar n√∫mero de orden";
          workOrderError.style.display = "block";
          workOrderVerificationStatus.verified = false;
          workOrderVerificationStatus.isUnique = false;

          // Hacer que el campo se vea como error
          workOrderInput.style.borderColor = "#dc3545";
          workOrderInput.style.backgroundColor = "#fff5f5";

          return false; // Error = no permitir continuar
        }
      }

      async function verifyPlateAutomatically(plate) {
        if (!plate || plate.length < 3) {
          plateStatus.innerHTML = "";
          plateVerificationStatus.verified = false;
          return;
        }

        const cleanPlate = plate.toUpperCase().trim();

        // No verificar si ya se verific√≥ la misma placa
        if (
          plateVerificationStatus.lastCheckedPlate === cleanPlate &&
          plateVerificationStatus.verified
        ) {
          return;
        }

        try {
          plateStatus.innerHTML = `<span style="color: #007bff;">üîç Verificando placa ${cleanPlate}...</span>`;

          const response = await fetch(
            `/api/cars/verify/${encodeURIComponent(cleanPlate)}`
          );
          const data = await response.json();

          if (response.ok && data.success) {
            plateVerificationStatus.verified = true;
            plateVerificationStatus.lastCheckedPlate = cleanPlate;

            if (data.exists) {
              plateVerificationStatus.exists = true;
              plateVerificationStatus.vehicleData = data.data;

              plateStatus.innerHTML = `
                <span style="color: #28a745;">
                  ‚úÖ ${data.data.marca} ${data.data.modelo} - ${
                data.data.propietario
              }${data.data.telefono ? ` - Tel: ${data.data.telefono}` : ""}
                </span>
              `;
            } else {
              plateVerificationStatus.exists = false;
              plateVerificationStatus.vehicleData = null;

              plateStatus.innerHTML = `
                <span style="color: #dc3545;">
                  ‚ùå Placa no registrada - 
                  <a href="#" onclick="redirectToCreateVehicle('${cleanPlate}')" style="color: #007bff; text-decoration: underline;">
                    Registrar veh√≠culo
                  </a>
                </span>
              `;
            }
          } else {
            plateStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Error al verificar placa</span>`;
            plateVerificationStatus.verified = false;
          }
        } catch (error) {
          console.error("Error verificando placa:", error);
          plateStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Error de conexi√≥n</span>`;
          plateVerificationStatus.verified = false;
        }
      }

      function redirectToCreateVehicle(plate) {
        const workOrder = workOrderInput.value.trim();
        let url = `cars.html?plate=${encodeURIComponent(plate)}`;
        if (workOrder) {
          url += `&workOrder=${encodeURIComponent(workOrder)}`;
        }
        window.location.href = url;
      }

      // Event listeners para verificaci√≥n autom√°tica de placa
      plateInput.addEventListener("blur", function () {
        const plate = this.value.trim();
        if (plate) {
          verifyPlateAutomatically(plate);
        }
      });

      plateInput.addEventListener("keydown", async function (event) {
        if (event.key === "Tab" || event.key === "Enter") {
          const plate = this.value.trim();
          if (plate) {
            await verifyPlateAutomatically(plate);

            // Si es Enter y la placa est√° registrada, enfocar el primer campo de detalle
            if (
              event.key === "Enter" &&
              plateVerificationStatus.verified &&
              plateVerificationStatus.exists
            ) {
              event.preventDefault();

              // Buscar el primer campo de detalle disponible
              const firstDetailInput = document.querySelector(
                ".invoice-item-detail"
              );
              if (firstDetailInput) {
                firstDetailInput.focus();
              } else {
                // Si no hay campos de detalle, crear uno nuevo y enfocarlo
                setTimeout(() => {
                  const newRow = createInvoiceRow();
                  const detailInput = newRow.querySelector(
                    ".invoice-item-detail"
                  );
                  if (detailInput) {
                    detailInput.focus();
                  }
                }, 100);
              }
            }
          }
        }
      });

      // Event listeners para verificaci√≥n autom√°tica de n√∫mero de orden
      workOrderInput.addEventListener("blur", async function () {
        const workOrder = this.value.trim();
        if (workOrder) {
          await verifyWorkOrderNumber(workOrder);
        }
      });

      workOrderInput.addEventListener("keydown", async function (event) {
        console.log("‚å®Ô∏è Keydown evento:", event.key);
        if (event.key === "Tab" || event.key === "Enter") {
          const workOrder = this.value.trim();
          console.log("üéØ Verificando en keydown:", workOrder);
          if (workOrder) {
            // Verificar inmediatamente al presionar Tab o Enter
            await verifyWorkOrderNumber(workOrder);

            // Si el n√∫mero de orden no es √∫nico, bloquear la navegaci√≥n
            if (
              workOrderVerificationStatus.verified &&
              !workOrderVerificationStatus.isUnique
            ) {
              console.log("üö´ BLOQUEANDO navegaci√≥n - n√∫mero duplicado");
              event.preventDefault(); // Evitar que se mueva al siguiente campo
              this.focus(); // Mantener el foco en este campo
              return false;
            } else {
              console.log("‚úÖ Permitiendo navegaci√≥n - n√∫mero √∫nico");
            }
          }
        }
      });

      // Verificaci√≥n autom√°tica mejorada del n√∫mero de orden
      let workOrderTimeout;
      workOrderInput.addEventListener("input", function () {
        const currentWorkOrder = this.value.trim();

        // Limpiar timeout anterior
        if (workOrderTimeout) {
          clearTimeout(workOrderTimeout);
        }

        // Resetear estado si el n√∫mero cambi√≥
        if (
          currentWorkOrder !== workOrderVerificationStatus.lastCheckedWorkOrder
        ) {
          workOrderError.style.display = "none";
          workOrderVerificationStatus.verified = false;
          workOrderVerificationStatus.isUnique = true;

          // Restaurar apariencia normal del campo
          workOrderInput.style.borderColor = "#ddd";
          workOrderInput.style.backgroundColor = "white";
        }

        // Verificar autom√°ticamente despu√©s de 500ms de inactividad (m√°s r√°pido)
        if (currentWorkOrder && currentWorkOrder.length > 0) {
          workOrderTimeout = setTimeout(async () => {
            await verifyWorkOrderNumber(currentWorkOrder);
          }, 500);
        }
      });

      // Limpiar estado cuando el usuario est√° escribiendo
      plateInput.addEventListener("input", function () {
        const currentPlate = this.value.trim().toUpperCase();
        if (currentPlate !== plateVerificationStatus.lastCheckedPlate) {
          plateStatus.innerHTML = "";
          plateVerificationStatus.verified = false;
          plateVerificationStatus.exists = false;
        }
      });

      const invoiceItemsContainer = document.getElementById(
        "invoice-items-container"
      );
      const invoiceTotalSpan = document.getElementById("invoice-total");

      // --- Invoice Functions ---
      function createInvoiceRow() {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("invoice-item-row");
        rowDiv.style.cssText =
          "display: flex; gap: 8px; margin-bottom: 12px; align-items: center; width: 100%;";

        const detailInput = document.createElement("input");
        detailInput.type = "text";
        detailInput.placeholder = "Detalle del servicio";
        detailInput.classList.add("invoice-item-detail");
        detailInput.style.cssText =
          "flex: 3; text-transform: uppercase; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;";

        const valueInput = document.createElement("input");
        valueInput.type = "number";
        valueInput.placeholder = "Valor";
        valueInput.classList.add("invoice-item-value");
        valueInput.min = "0";
        valueInput.step = "0.01";
        valueInput.style.cssText =
          "flex: 1.5; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 120px;";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "√ó";
        removeBtn.classList.add("remove-invoice-item-btn");
        removeBtn.style.cssText =
          "background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;";

        rowDiv.appendChild(detailInput);
        rowDiv.appendChild(valueInput);
        rowDiv.appendChild(removeBtn);
        invoiceItemsContainer.appendChild(rowDiv);

        // Add event listeners for the new row
        valueInput.addEventListener("input", calculateTotal);
        valueInput.addEventListener("keydown", handleValueEnter);
        removeBtn.addEventListener("click", () => {
          rowDiv.remove();
          calculateTotal();
        });

        // Navegaci√≥n del campo detalle al campo valor
        detailInput.addEventListener("keydown", function (event) {
          if (event.key === "Tab" || event.key === "Enter") {
            const detailValue = this.value.trim();

            // Verificar si este es el √∫ltimo campo de detalle
            const allDetailInputs = invoiceItemsContainer.querySelectorAll(
              ".invoice-item-detail"
            );
            const isLastDetailInput =
              this === allDetailInputs[allDetailInputs.length - 1];

            if (!detailValue && !isLastDetailInput) {
              // Solo validar si NO es el √∫ltimo campo de detalle
              event.preventDefault();
              this.focus();
              // Agregar feedback visual temporal
              this.style.borderColor = "#dc3545";
              this.style.backgroundColor = "#fff5f5";

              // Restaurar estilo despu√©s de 2 segundos
              setTimeout(() => {
                this.style.borderColor = "#ddd";
                this.style.backgroundColor = "white";
              }, 2000);

              return false;
            } else if (event.key === "Enter" && detailValue) {
              // Si hay contenido y se presiona Enter, mover al campo valor
              event.preventDefault();
              const valueInput = rowDiv.querySelector(".invoice-item-value");
              if (valueInput) {
                valueInput.focus();
              }
            }
            // Si es el √∫ltimo campo de detalle, permitir navegaci√≥n normal con TAB
          }
        });

        // Limpiar estilo de error cuando el usuario empiece a escribir
        detailInput.addEventListener("input", function () {
          this.style.borderColor = "#ddd";
          this.style.backgroundColor = "white";
        });

        // Validaci√≥n adicional en blur (cuando pierde el foco) - solo para campos que no son el √∫ltimo
        detailInput.addEventListener("blur", function () {
          const detailValue = this.value.trim();

          // Verificar si este es el √∫ltimo campo de detalle
          const allDetailInputs = invoiceItemsContainer.querySelectorAll(
            ".invoice-item-detail"
          );
          const isLastDetailInput =
            this === allDetailInputs[allDetailInputs.length - 1];

          if (!detailValue && !isLastDetailInput) {
            // Solo mostrar error si NO es el √∫ltimo campo de detalle
            this.style.borderColor = "#dc3545";
            this.style.backgroundColor = "#fff5f5";
          }
        });

        detailInput.focus(); // Focus on the detail input of the new row
        return rowDiv;
      }

      function handleValueEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          createInvoiceRow(); // Add a new row when Enter is pressed in the value field
        } else if (event.key === "Tab") {
          // Verificar si este es el √∫ltimo campo de valor
          const allValueInputs = invoiceItemsContainer.querySelectorAll(
            ".invoice-item-value"
          );
          const currentInput = event.target;
          const isLastValueInput =
            currentInput === allValueInputs[allValueInputs.length - 1];

          if (isLastValueInput) {
            // Si es el √∫ltimo campo de valor, mover el cursor al bot√≥n "Registrar Servicio"
            event.preventDefault();
            const submitBtn = document.getElementById("submit-btn");
            if (submitBtn) {
              submitBtn.focus();
            }
          }
        }
      }

      function calculateTotal() {
        const valueInputs = invoiceItemsContainer.querySelectorAll(
          ".invoice-item-value"
        );
        let total = 0;
        valueInputs.forEach((input) => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        // Format as currency (e.g., COP)
        invoiceTotalSpan.textContent = new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
        }).format(total);
      }

      // --- Initial Setup ---
      // Start with one empty row
      createInvoiceRow();

      // Event listener para el bot√≥n de agregar detalle
      document
        .getElementById("add-detail-btn")
        .addEventListener("click", function () {
          createInvoiceRow();
        });

      // -- Form Submit Listener --
      document
        .getElementById("serviceForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          messageArea.textContent = "";
          messageArea.style.color = "black";

          const plate = plateInput.value.toUpperCase().trim();
          const workOrderValue = workOrderInput.value.trim();

          if (!plate || !workOrderValue) {
            return;
          }

          // --- Verificar n√∫mero de orden duplicado ---
          console.log(
            "üîç FORMULARIO: Verificando n√∫mero de orden antes de env√≠o"
          );
          console.log(
            "üìä Estado actual antes de verificar:",
            workOrderVerificationStatus
          );

          if (
            !workOrderVerificationStatus.verified ||
            workOrderVerificationStatus.lastCheckedWorkOrder !== workOrderValue
          ) {
            console.log("üîÑ Ejecutando nueva verificaci√≥n...");
            // Si no se ha verificado o el n√∫mero cambi√≥, verificar ahora
            const isUnique = await verifyWorkOrderNumber(workOrderValue);
            console.log("‚úÖ Resultado de verificaci√≥n:", isUnique);

            // Esperar un momento para que se complete la verificaci√≥n
            await new Promise((resolve) => setTimeout(resolve, 100));
          }

          console.log(
            "üìä Estado final despu√©s de verificar:",
            workOrderVerificationStatus
          );

          // BLOQUEAR ENV√çO si el n√∫mero de orden ya existe
          if (
            workOrderVerificationStatus.verified &&
            !workOrderVerificationStatus.isUnique
          ) {
            console.log("üö´ BLOQUEANDO ENV√çO - n√∫mero duplicado detectado");
            // Mostrar el error y enfocar el campo
            workOrderError.textContent = `‚ö†Ô∏è El n√∫mero de orden ${workOrderValue} ya existe. No se puede continuar.`;
            workOrderError.style.display = "block";
            workOrderInput.style.borderColor = "#dc3545";
            workOrderInput.style.backgroundColor = "#fff5f5";
            workOrderInput.focus();
            workOrderInput.select(); // Seleccionar el texto para f√°cil correcci√≥n

            return; // DETENER completamente el proceso
          }

          console.log("‚úÖ N√∫mero de orden v√°lido, continuando con env√≠o...");

          // --- Verificar placa usando la verificaci√≥n previa ---
          if (
            !plateVerificationStatus.verified ||
            plateVerificationStatus.lastCheckedPlate !== plate
          ) {
            // Si no se ha verificado o la placa cambi√≥, verificar ahora
            await verifyPlateAutomatically(plate);

            // Esperar un momento para que se complete la verificaci√≥n
            await new Promise((resolve) => setTimeout(resolve, 500));
          }

          // Verificar el estado actual de la placa
          if (!plateVerificationStatus.verified) {
            return;
          }

          if (!plateVerificationStatus.exists) {
            // Redireccionar directamente al registro de veh√≠culos
            redirectToCreateVehicle(plate);
            return;
          }

          // Si llegamos aqu√≠, la placa existe y est√° verificada
          const vehicleData = plateVerificationStatus.vehicleData;

          // --- Gather Invoice Data ---
          const invoiceRows =
            invoiceItemsContainer.querySelectorAll(".invoice-item-row");
          let workDescription = "";
          let calculatedCost = 0;
          let validItemsCount = 0;

          for (let i = 0; i < invoiceRows.length; i++) {
            const row = invoiceRows[i];
            const detailInput = row.querySelector(".invoice-item-detail");
            const valueInput = row.querySelector(".invoice-item-value");
            const detail = detailInput.value.trim().toUpperCase();
            const valueStr = valueInput.value.trim();
            const value = parseFloat(valueStr);

            // Skip empty rows
            if (!detail && (!valueStr || value === 0)) {
              continue;
            }

            // Validate non-empty rows
            if (!detail) {
              // Agregar feedback visual para campo detalle vac√≠o
              detailInput.style.borderColor = "#dc3545";
              detailInput.style.backgroundColor = "#fff5f5";
              detailInput.focus();

              // Mostrar mensaje temporal
              messageArea.textContent =
                "‚ö†Ô∏è Por favor, complete el detalle del servicio antes de continuar.";
              messageArea.style.color = "#dc3545";
              messageArea.style.fontWeight = "bold";

              // Limpiar mensaje despu√©s de 3 segundos
              setTimeout(() => {
                messageArea.textContent = "";
                messageArea.style.color = "black";
                messageArea.style.fontWeight = "normal";
              }, 3000);

              return;
            }

            if (!valueStr || isNaN(value) || value < 0) {
              // Agregar feedback visual para campo valor vac√≠o/inv√°lido
              valueInput.style.borderColor = "#dc3545";
              valueInput.style.backgroundColor = "#fff5f5";
              valueInput.focus();

              // Mostrar mensaje temporal
              messageArea.textContent =
                "‚ö†Ô∏è Por favor, ingrese un valor v√°lido para el servicio.";
              messageArea.style.color = "#dc3545";
              messageArea.style.fontWeight = "bold";

              // Limpiar mensaje despu√©s de 3 segundos
              setTimeout(() => {
                messageArea.textContent = "";
                messageArea.style.color = "black";
                messageArea.style.fontWeight = "normal";
              }, 3000);

              return;
            }

            workDescription += `${detail}: ${new Intl.NumberFormat("es-CO", {
              style: "currency",
              currency: "COP",
            }).format(value)}\\n`;
            calculatedCost += value;
            validItemsCount++;
          }

          if (validItemsCount === 0) {
            return;
          }

          // Submit service
          try {
            const response = await fetch("/api/services", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orden_trabajo: parseInt(workOrderValue),
                placa: plate,
                descripcion: workDescription.trim(),
                costo: calculatedCost,
              }),
            });

            const responseData = await response.json();

            if (response.ok) {
              // Servicio guardado exitosamente - limpiar formulario sin mostrar modal
              // Limpiar formulario inmediatamente
              clearServiceForm();
            } else {
              // Solo mostrar errores del servidor
              messageArea.textContent = `Error: ${
                responseData.message || "Ocurri√≥ un error"
              }`;
              messageArea.style.color = "red";
            }
          } catch (error) {
            console.error("Error al registrar servicio:", error);
            messageArea.textContent = "Error de conexi√≥n. Intente nuevamente.";
            messageArea.style.color = "red";
          }
        });

      // Manejar bot√≥n de cerrar sesi√≥n
      document
        .getElementById("logoutBtn")
        .addEventListener("click", function () {
          if (confirm("¬øEst√° seguro de que desea cerrar sesi√≥n?")) {
            localStorage.removeItem("isAuthenticated");
            localStorage.removeItem("username");
            localStorage.removeItem("loginTime");
            window.location.href = "login.html";
          }
        });
    </script>
  </body>
</html>
